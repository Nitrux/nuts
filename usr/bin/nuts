#! /bin/bash

#############################################################################################################################################################################
#   The license used for this file and its contents is: BSD-3-Clause                                                                                                        #
#                                                                                                                                                                           #
#   Copyright <2023> <Luis Lavaire <luis_lavaire@nxos.org>>                                                                                                                 #
#   Copyright <2023> <Uri Herrera <uri_herrera@nxos.org>>                                                                                                                   #
#                                                                                                                                                                           #
#   Redistribution and use in source and binary forms, with or without modification, are permitted provided that the following conditions are met:                          #
#                                                                                                                                                                           #
#    1. Redistributions of source code must retain the above copyright notice, this list of conditions and the following disclaimer.                                        #
#                                                                                                                                                                           #
#    2. Redistributions in binary form must reproduce the above copyright notice, this list of conditions and the following disclaimer                                      #
#       in the documentation and/or other materials provided with the distribution.                                                                                         #
#                                                                                                                                                                           #
#    3. Neither the name of the copyright holder nor the names of its contributors may be used to endorse or promote products derived from this software                    #
#       without specific prior written permission.                                                                                                                          #
#                                                                                                                                                                           #
#    THIS SOFTWARE IS PROVIDED BY THE COPYRIGHT HOLDERS AND CONTRIBUTORS "AS IS" AND ANY EXPRESS OR IMPLIED WARRANTIES, INCLUDING, BUT NOT LIMITED TO,                      #
#    THE IMPLIED WARRANTIES OF MERCHANTABILITY AND FITNESS FOR A PARTICULAR PURPOSE ARE DISCLAIMED. IN NO EVENT SHALL THE COPYRIGHT HOLDER OR CONTRIBUTORS                  #
#    BE LIABLE FOR ANY DIRECT, INDIRECT, INCIDENTAL, SPECIAL, EXEMPLARY, OR CONSEQUENTIAL DAMAGES (INCLUDING, BUT NOT LIMITED TO, PROCUREMENT OF SUBSTITUTE                 #
#    GOODS OR SERVICES; LOSS OF USE, DATA,   OR PROFITS; OR BUSINESS INTERRUPTION) HOWEVER CAUSED AND ON ANY THEORY OF LIABILITY, WHETHER IN CONTRACT,                      #
#    STRICT LIABILITY, OR TORT (INCLUDING NEGLIGENCE OR OTHERWISE) ARISING IN ANY WAY OUT OF THE USE OF THIS SOFTWARE, EVEN IF ADVISED OF THE POSSIBILITY OF SUCH DAMAGE.   #
#############################################################################################################################################################################


iso_img=nitrux-nx-desktop-latest.iso
base_url=https://nxos.org/ftp_up


# This gets executed INSIDE the chroot only.
[ $SYNC_NEW_ROOT ] && {
    mount -t devtmpfs dev /dev
    curl -o .iso $base_url/$iso_img

    mnt=`mktemp -d`

    mount .iso $mnt
    mount $mnt/casper/filesystem.squashfs $mnt

    rsync -avzh \
        --exclude $mnt/var \
        --exclude $mnt/dev \
        --exclude $mnt/run \
        --exclude $mnt/sys \
        --exclude $mnt/proc \
        --exclude $mnt/home \
        --exclude $mnt/etc/shadow \
        --progress \
        $mnt /

    # Unmount all the filesystems mounted there.
    while mountpoint $mnt; do umount $mnt; done
    umount /dev

    rm .iso

    # We don't want to execute the rest of this script.
    exit
}


# This gets executed INSIDE the chroot only.
[ $SYNC_BACKUP ] && {
    mount -t devtmpfs dev /dev

    mnt=`mktemp -d`

    mount $(grep /home /proc/mounts | awk '{print $1}') $mnt
    mount $mnt/home/.nuts/backup.squashfs $mnt

    rsync -avzh \
        --exclude $mnt/var \
        --exclude $mnt/dev \
        --exclude $mnt/run \
        --exclude $mnt/sys \
        --exclude $mnt/proc \
        --exclude $mnt/home \
        --exclude $mnt/etc/shadow \
        --progress \
        $mnt /

    umount $mnt

    rm $mnt/home/.nuts/backup.squashfs

    # We don't want to execute the rest of this script.
    exit
}


# This gets executed OUTSIDE the chroot only.
for cmd; do
    case "$cmd" in
        ( update )
            # Check if the remote checksum differs from the local.
            curl $base_url/installed_pkgs_end.txt \
                | diff -q - /installed_pkgs_end.txt \

            [ $? = 0 ] && {
                echo "The system is up to date."
                exit
            }

            # Create the backup.
            mksquashfs / /home/.nuts/backup.squashfs \
                -e /var \
                -e /dev \
                -e /run \
                -e /sys \
                -e /boot \
                -e /proc \
                -e /home \
                -e /media \
                -ef /etc/shadow \
                -comp zstd \
                -Xcompression-level 22 \
                -no-progress \
                -b 1048576

            # We're done on this side. Now run overlayroot-chroot.
            cat "$0" | SYNC_NEW_ROOT=1 overlayroot-chroot bash

            update-grub
            reboot;;

        ( restore )
            [ -f /home/.nuts/backup.squashfs ] \
                || { echo "No backup found."; exit 1; }

            # We're done on this side. Now run overlayroot-chroot.
            cat "$0" | SYNC_BACKUP=1 overlayroot-chroot bash;;

            update-grub
            reboot;;
    esac
done
