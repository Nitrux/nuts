#!/usr/bin/env bash

# SPDX-License-Identifier: BSD-3-Clause
# Copyright 2023-2026 <Nitrux Latinoamericana S.C. <hello@nxos.org>>


# -- Exit on errors.

set -eu


# -- Set program name and version.

TOOL_NAME="Nitrux Update Tool System"
COMP_NAME="(Self-Update Component)"
SUP_VERSION="$(md5sum "$0" | cut -c -32)"


# -- Source shared functions safely.
# -- If the library is missing (first run on old system), define fallbacks so the script doesn't crash.

if [ -f "/usr/lib/nuts/functions" ]; then
    # shellcheck source=/dev/null
    . "/usr/lib/nuts/functions"
else
    puts_info()    { printf 'Info: %s\n' "$*" >&2; }
    puts_success() { printf 'Success: %s\n' "$*" >&2; }
    puts_warning() { printf 'Warning: %s\n' "$*" >&2; }
    puts_error()   { printf 'Error: %s\n' "$*" >&2; }
    
    spinner() {
        local pid=$1
        while kill -0 "$pid" 2>/dev/null; do
            printf '.'
            sleep 0.5
        done
        printf '\n'
    }
    
    unmount_directory() {
        if mountpoint -q "$1"; then umount "$1"; fi
    }

    overlay_ch() {
        if ! command -v overlayroot-chroot >/dev/null 2>&1; then
            puts_error "Error: 'overlayroot-chroot' command not found."
            return 1
        fi
        overlayroot-chroot "$@"
    }
fi


# -- Display version of running component.

puts_info "$TOOL_NAME $COMP_NAME version $SUP_VERSION."


# -- Define the path of the configuration file.

CONFIG_FILE="/etc/nuts.conf"


# -- Load values from configuration file.
# -- Include fix for SC1090 – ShellCheck.

if [[ ! -f $CONFIG_FILE ]]; then
    puts_error "$TOOL_NAME configuration file not found!, quitting." 2>&1
    exit 1
else
    puts_success "$TOOL_NAME configuration file found, continuing..."
    # shellcheck source=/dev/null
    . "$CONFIG_FILE"
fi


# -- Component-specific functions.

cleanup() {
    local exit_code=$?
    
    [ -d "$NUTS_GIT_DIR" ] && rm -rf "$NUTS_GIT_DIR"
    
    unmount_directory "/tmp"
    unmount_directory "/dev"
    
    if [ $exit_code -ne 0 ]; then
        puts_error "Component exited unexpectedly with code $exit_code."
    fi
}

trap cleanup EXIT

#   ====== START ======

# -- Save current value of NUTS_BRANCH.

CURRENT_NUTS_BRANCH=$(grep -oP '^NUTS_BRANCH=\K.*' "$CONFIG_FILE")


# -- Mount the tmp filesystem.
# -- Apparently this is required now? ¯\_(ツ)_/¯

if mountpoint -q /tmp; then
    tmp_type=$(findmnt -n -o FSTYPE --target /tmp)
    if [ "$tmp_type" = "tmpfs" ]; then
        puts_info "/tmp is already mounted as tmpfs."
    else
        puts_warning "/tmp is mounted as $tmp_type, expected tmpfs. Remounting..."
        umount /tmp
        mount -t tmpfs tmp /tmp
    fi
else
    puts_info "Mounting: /tmp"
    mount -t tmpfs tmp /tmp
fi


# -- Update utility.
# -- Use the GitHub archive URL to download only the specific branch as a tarball.

puts_info "Updating $TOOL_NAME to the latest version, continuing..."

NUTS_GIT_DIR=$(mktemp -d -p /tmp)
ARCHIVE_URL="https://github.com/Nitrux/nuts/archive/refs/heads/$NUTS_BRANCH.tar.gz"

if ! curl -Ls "$ARCHIVE_URL" | tar -xz -m -C "$NUTS_GIT_DIR" --strip-components=1; then
    puts_error "Failed to download update repository."
    exit 1
fi


# -- Define paths for clarity.

INSTALLED_BIN="/usr/bin/nuts"
INSTALLED_LIB="/usr/lib/nuts/functions"
NEW_BIN="$NUTS_GIT_DIR/usr/bin/nuts"
NEW_LIB="$NUTS_GIT_DIR/usr/lib/nuts/functions"


# -- Check if:
#   -- 1. The installed binary or library is missing.
#   -- 2. The checksum of the binary has changed.
#   -- 3. The checksum of the shared library has changed.

if [ ! -f "$INSTALLED_BIN" ] || \
   [ ! -f "$INSTALLED_LIB" ] || \
   [ "$(md5sum "$NEW_BIN" | awk '{print $1}')" != "$(md5sum "$INSTALLED_BIN" | awk '{print $1}')" ] || \
   [ "$(md5sum "$NEW_LIB" | awk '{print $1}')" != "$(md5sum "$INSTALLED_LIB" | awk '{print $1}')" ]; then
   
    puts_info "$TOOL_NAME is being updated, continuing..."
    
    mkdir -p /usr/lib/nuts

    if cp "$NEW_BIN" /usr/bin && \
       cp "$NEW_LIB" /usr/lib/nuts && \
       cp "$NUTS_GIT_DIR/etc/nuts.conf" /etc; then
        :
    else
        puts_error "Failed to copy update files."
        exit 1
    fi
else
    puts_info "$TOOL_NAME is already at the latest version. Bye."
    exit 0
fi


# -- Restore the value of NUTS_BRANCH in /etc/nuts.conf.

if [[ -n $CURRENT_NUTS_BRANCH ]]; then
    sed -i "s/^NUTS_BRANCH=.*$/NUTS_BRANCH=$CURRENT_NUTS_BRANCH/" "$CONFIG_FILE"
else
    puts_error "Failed to restore $TOOL_NAME branch, quitting." 
    exit 1
fi


# -- **DO NOT PERFORM ANY FILE OPERATION AFTER THIS POINT**

sync

puts_success "$TOOL_NAME has been updated."


# -- Display message to the user.

puts_warning "⚠️ Important: Do not continue using the system in this state. Reboot to load the changes into the overlay and finalize the update."


# -- Unmount directories after update and before exiting chroot.

unmount_directory "/tmp" > /dev/null 2>&1

#   ====== END ======
